<?xml version="1.0" encoding="utf-8"?>
<StructureDefinition xmlns="http://hl7.org/fhir">
  <id value="observation-visual-acuity" />
  <url value="https://larfuma.github.io/fhir-eyecare-ig/StructureDefinition-observation-visual-acuity" />
  <name value="ObservationVisualAcuity" />
  <title value="Visual Acuity (VA)" />
  <status value="draft" />
  <experimental value="true" />
  <description value="An assessment of a patients ability to see." />
  <fhirVersion value="4.0.1" />
  <kind value="resource" />
  <abstract value="false" />
  <type value="Observation" />
  <baseDefinition value="http://hl7.org/fhir/uv/eyecare/StructureDefinition/observation-base" />
  <derivation value="constraint" />
  <differential>
    <element id="Observation.extension:ownCorrectionDuringVATest">
      <path value="Observation.extension" />
      <sliceName value="ownCorrectionDuringVATest" />
      <type>
        <code value="Extension" />
        <profile value="https://example.org/fhir/StructureDefinition/OwnCorrectionDuringVA" />
      </type>
      <isModifier value="false" />
    </element>
    <element id="Observation.code">
      <path value="Observation.code" />
      <fixedCodeableConcept>
        <coding>
          <system value="http://snomed.info/sct" />
          <code value="260246004" />
          <display value="Visual Acuity finding" />
        </coding>
      </fixedCodeableConcept>
    </element>
    <element id="Observation.code.coding">
      <path value="Observation.code.coding" />
      <slicing>
        <discriminator>
          <type value="value" />
          <path value="$this" />
        </discriminator>
        <rules value="open" />
      </slicing>
      <short value="Visual Acuity Observables" />
      <binding>
        <strength value="preferred" />
        <valueSet value="http://terminology.hl7.org/uv/eyecare/ValueSet/observation-visual-acuity" />
      </binding>
    </element>
    <element id="Observation.value[x]">
      <path value="Observation.value[x]" />
      <slicing>
        <discriminator>
          <type value="type" />
          <path value="$this" />
        </discriminator>
        <ordered value="false" />
        <rules value="open" />
      </slicing>
      <type>
        <code value="Ratio" />
      </type>
      <type>
        <code value="Quantity" />
      </type>
      <type>
        <code value="CodeableConcept" />
      </type>
      <mustSupport value="true" />
    </element>
    <element id="Observation.value[x]:valueRatio">
      <path value="Observation.value[x]" />
      <sliceName value="valueRatio" />
      <short value="Visual acuity expressed as a Snellen fraction" />
      <definition value="Visual acuity expressed as a Snellen fraction." />
      <type>
        <code value="Ratio" />
      </type>
      <constraint>
        <key value="inv-dh-va-01" />
        <severity value="error" />
        <human value="Value shall include numerator value and denominator value" />
        <expression value="numerator.value.exists() and denominator.value.exists()" />
      </constraint>
    </element>
    <element id="Observation.value[x]:valueQuantity">
      <path value="Observation.value[x]" />
      <sliceName value="valueQuantity" />
      <short value="Visual acuity expressed as a simple quantity" />
      <definition value="Visual acuity expressed as a simple quantity." />
      <comment value="This is suitable for LogMAR, N-point and M-size notations, and also for decimal notation with units '/arcmin'." />
      <type>
        <code value="Quantity" />
      </type>
      <constraint>
        <key value="inv-dh-va-02" />
        <severity value="error" />
        <human value="Value shall include value and unit" />
        <expression value="value.exists() and unit.exists()" />
        <source value="http://ns.electronichealth.net.au/fhir/StructureDefinition/dh-observation-visualacuity-1" />
      </constraint>
    </element>
    <element id="Observation.value[x]:valueCodeableConcept">
      <path value="Observation.value[x]" />
      <sliceName value="valueCodeableConcept" />
      <short value="Visual acuity expressed as a code" />
      <definition value="Visual acuity expressed as a code" />
      <comment value="This is suitable for expressing low vision." />
      <type>
        <code value="CodeableConcept" />
      </type>
      <binding>
        <strength value="preferred" />
        <valueSet value="https://larfuma.github.io/fhir-eyecare-ig/ValueSet-visual-acuity-categorical-values" />
      </binding>
    </element>
    <element id="Observation.value[x]:valueString">
      <path value="Observation.value[x]" />
      <sliceName value="valueString" />
      <short value="Visual acuity expressed as a string (discouraged!)" />
      <definition value="Visual acuity expressed as a string. Use of string values is strongly discouraded, it is neither necessary from an ophthalmological nor from a technical standpoint. It should only be used where legacy systems have already stored VA values as strings and transformation to structured is not possible due to regulatory constraints." />
      <type>
        <code value="string" />
      </type>
      <constraint>
        <key value="inv-va-01" />
        <severity value="warning" />
        <human value="Use of valueString is discouraged; please use structured data types instead." />
        <expression value="true" />
      </constraint>
    </element>
    <element id="Observation.note">
      <path value="Observation.note" />
      <short value="Free text note or Comments about the VA observation" />
      <definition value="If there is a free text field that relates to the VA observation, it should be included as this note. Although this is not encouraged, free text notes may include information that is crucial to the interpretation of the visual acuity which could not be entered in other fields. For example, some systems may not support all of the observation.component values. Therefore, if a free text note about a VA measurement is available, it should be included here and it should be available for future interpretation of the VA measurement." />
      <mustSupport value="true" />
    </element>
    <element id="Observation.bodySite">
      <path value="Observation.bodySite" />
      <definition value="Which eye(s) were used for the visual acuity test? note that both eyes refers to a binocular visuin test, it does not mean that each of the eyes alone has the specified VA value! Also, when a Patient uses an extrocular device such as a worn camera devicefor the VA test, please use &quot;Topography not assigned&quot; and use specify the device in observation.device" />
      <min value="1" />
      <binding>
        <strength value="required" />
        <valueSet value="https://larfuma.github.io/fhir-eyecare-ig/ValueSet-Visual-Acuity-BodySite" />
      </binding>
    </element>
    <element id="Observation.method">
      <path value="Observation.method" />
      <short value="VA measurement Method" />
      <definition value="This is used to document the general Method by which VA measurement performed, Note that all Visual acuity Charts with optotypes are either a &quot;Visual Acuity Chart&quot; or &quot;Near Card&quot;, the optotypes are specified as a .component." />
    </element>
    <element id="Observation.method.coding">
      <path value="Observation.method.coding" />
      <min value="1" />
      <binding>
        <strength value="preferred" />
        <valueSet value="https://larfuma.github.io/fhir-eyecare-ig/ValueSet-observation-visual-acuity-methods" />
      </binding>
    </element>
    <element id="Observation.referenceRange">
      <path value="Observation.referenceRange" />
      <max value="1" />
    </element>
    <element id="Observation.component">
      <path value="Observation.component" />
      <slicing>
        <discriminator>
          <type value="value" />
          <path value="code" />
        </discriminator>
        <ordered value="false" />
        <rules value="open" />
      </slicing>
    </element>
    <element id="Observation.component:Pinhole-Occluder-Usage">
      <path value="Observation.component" />
      <sliceName value="Pinhole-Occluder-Usage" />
      <short value="Pinhole Occluder Used" />
      <definition value="Indicates whether a pinhole occluder was used during the visual acuity measurement." />
      <max value="1" />
    </element>
    <element id="Observation.component:Pinhole-Occluder-Usage.code">
      <path value="Observation.component.code" />
      <fixedCodeableConcept>
        <coding>
          <system value="http://snomed.info/sct" />
          <code value="257492003" />
          <display value="Pinhole Occluder" />
        </coding>
      </fixedCodeableConcept>
    </element>
    <element id="Observation.component:Pinhole-Occluder-Usage.value[x]">
      <path value="Observation.component.value[x]" />
      <slicing>
        <discriminator>
          <type value="type" />
          <path value="$this" />
        </discriminator>
        <ordered value="false" />
        <rules value="open" />
      </slicing>
      <type>
        <code value="CodeableConcept" />
      </type>
    </element>
    <element id="Observation.component:Pinhole-Occluder-Usage.value[x]:valueCodeableConcept">
      <path value="Observation.component.value[x]" />
      <sliceName value="valueCodeableConcept" />
      <short value="Pinhole Occluder Usage Value" />
      <definition value="The value indicating pinhole occluder usage." />
      <type>
        <code value="CodeableConcept" />
      </type>
      <binding>
        <strength value="preferred" />
        <valueSet value="https://larfuma.github.io/fhir-eyecare-ig/ValueSet-pinhole-occluder-usage" />
      </binding>
    </element>
    <element id="Observation.component:Optotype-Presentation">
      <path value="Observation.component" />
      <sliceName value="Optotype-Presentation" />
      <short value="Optotype Presentation" />
      <definition value="Indicates whether the visual acuity test was conducted using single optotypes or optotype rows." />
      <max value="1" />
    </element>
    <element id="Observation.component:Optotype-Presentation.code">
      <path value="Observation.component.code" />
      <fixedCodeableConcept>
        <coding>
          <system value="https://larfuma.github.io/fhir-eyecare-ig/CodeSystem/custom-codes-to-be-submitted-to-SNOMED-or-LOINC" />
          <code value="optotype-presentation" />
          <display value="Optotype Presentation Type (Single or Row)" />
        </coding>
      </fixedCodeableConcept>
    </element>
    <element id="Observation.component:Optotype-Presentation.value[x]">
      <path value="Observation.component.value[x]" />
      <type>
        <code value="CodeableConcept" />
      </type>
      <binding>
        <strength value="preferred" />
        <description value="Valueset of Optotypes" />
        <valueSet value="https://larfuma.github.io/fhir-eyecare-ig/ValueSet/optotype-presentation" />
      </binding>
    </element>
    <element id="Observation.component:Test-Distance">
      <path value="Observation.component" />
      <sliceName value="Test-Distance" />
      <short value="Distance of Visual acuity Test" />
      <definition value="The distance at which the visual acuity test was performed." />
      <max value="1" />
    </element>
    <element id="Observation.component:Test-Distance.code">
      <path value="Observation.component.code" />
      <fixedCodeableConcept>
        <coding>
          <system value="http://snomed.info/sct" />
          <code value="252124009" />
          <display value="Test distance" />
        </coding>
      </fixedCodeableConcept>
    </element>
    <element id="Observation.component:Test-Distance.value[x]">
      <path value="Observation.component.value[x]" />
      <slicing>
        <discriminator>
          <type value="type" />
          <path value="$this" />
        </discriminator>
        <ordered value="false" />
        <rules value="open" />
      </slicing>
      <type>
        <code value="Quantity" />
      </type>
      <type>
        <code value="CodeableConcept" />
      </type>
    </element>
    <element id="Observation.component:Test-Distance.value[x]:valueCodeableConcept">
      <path value="Observation.component.value[x]" />
      <sliceName value="valueCodeableConcept" />
      <short value="Measurement Distance as Coded Concept" />
      <definition value="The distance at which the visual acuity test was performed, expressed as a coded concept (e.g., near, intermediate, far)." />
      <type>
        <code value="CodeableConcept" />
      </type>
      <binding>
        <strength value="preferred" />
        <valueSet value="https://larfuma.github.io/fhir-eyecare-ig/ValueSet-visual-acuity-test-distance" />
      </binding>
    </element>
    <element id="Observation.component:Optotype-used">
      <path value="Observation.component" />
      <sliceName value="Optotype-used" />
      <short value="Optotype used" />
      <definition value="The type of image or symbol that the patient had to discern for the Visual Acuity test, typically on a chart, card, screen, or projector image." />
      <max value="1" />
    </element>
    <element id="Observation.component:Optotype-used.code">
      <path value="Observation.component.code" />
      <code>
        <system value="https://larfuma.github.io/fhir-eyecare-ig/CodeSystem/custom-codes-to-be-submitted-to-SNOMED-or-LOINC" />
        <code value="Optotype" />
        <display value="Optotype" />
      </code>
    </element>
    <element id="Observation.component:Optotype-used.value[x]">
      <path value="Observation.component.value[x]" />
      <type>
        <code value="CodeableConcept" />
      </type>
      <binding>
        <strength value="preferred" />
        <valueSet value="https://larfuma.github.io/fhir-eyecare-ig/ValueSet-optotypes" />
      </binding>
    </element>
    <element id="Observation.component:Refractive-Correction">
      <path value="Observation.component" />
      <sliceName value="Refractive-Correction" />
      <short value="Refractive Correction Method and Details" />
      <definition value="Indicates the refractive correction method used during the visual acuity measurement and allows for specifying refractive values if applicable." />
      <mustSupport value="false" />
    </element>
    <element id="Observation.component:Refractive-Correction.value[x]">
      <path value="Observation.component.value[x]" />
      <type>
        <code value="CodeableConcept" />
      </type>
      <binding>
        <strength value="preferred" />
        <valueSet value="https://larfuma.github.io/fhir-eyecare-ig/ValueSet/visual-acuity-correction-methods" />
      </binding>
    </element>
    <element id="Observation.component:Trial-Sphere-Left-Eye">
      <path value="Observation.component" />
      <sliceName value="Trial-Sphere-Left-Eye" />
      <short value="Trial Spherical Correction for Left Eye" />
      <definition value="Trial spherical correction value used during the visual acuity test for the left eye." />
      <max value="1" />
    </element>
    <element id="Observation.component:Trial-Cylinder-Left-Eye">
      <path value="Observation.component" />
      <sliceName value="Trial-Cylinder-Left-Eye" />
      <short value="Trial Cylindrical Correction for Left Eye" />
      <definition value="Trial cylindrical correction value used during the visual acuity test for the left eye." />
      <max value="1" />
    </element>
    <element id="Observation.component:Trial-Cylinder-Left-Eye.value[x]">
      <path value="Observation.component.value[x]" />
      <type>
        <code value="Quantity" />
      </type>
    </element>
    <element id="Observation.component:Trial-Axis-Left-Eye">
      <path value="Observation.component" />
      <sliceName value="Trial-Axis-Left-Eye" />
      <short value="Trial Axis Correction for Left Eye" />
      <definition value="Trial axis of cylindrical correction used during the visual acuity test for the left eye." />
      <max value="1" />
    </element>
    <element id="Observation.component:Trial-Axis-Left-Eye.value[x]">
      <path value="Observation.component.value[x]" />
      <type>
        <code value="Quantity" />
      </type>
    </element>
    <element id="Observation.component:Trial-Sphere-Right-Eye">
      <path value="Observation.component" />
      <sliceName value="Trial-Sphere-Right-Eye" />
      <short value="Trial Spherical Correction for Right Eye" />
      <definition value="Trial spherical correction value used during the visual acuity test for the right eye." />
      <max value="1" />
    </element>
    <element id="Observation.component:Trial-Sphere-Right-Eye.value[x]">
      <path value="Observation.component.value[x]" />
      <type>
        <code value="Quantity" />
      </type>
    </element>
    <element id="Observation.component:Trial-Cylinder-Right-Eye">
      <path value="Observation.component" />
      <sliceName value="Trial-Cylinder-Right-Eye" />
      <short value="Trial Cylindrical Correction for Right Eye" />
      <definition value="Trial cylindrical correction value used during the visual acuity test for the right eye." />
      <max value="1" />
    </element>
    <element id="Observation.component:Trial-Cylinder-Right-Eye.value[x]">
      <path value="Observation.component.value[x]" />
      <type>
        <code value="Quantity" />
      </type>
    </element>
    <element id="Observation.component:Trial-Axis-Right-Eye">
      <path value="Observation.component" />
      <sliceName value="Trial-Axis-Right-Eye" />
      <short value="Trial Axis Correction for Right Eye" />
      <definition value="Trial axis of cylindrical correction used during the visual acuity test for the right eye." />
      <max value="1" />
    </element>
    <element id="Observation.component:Trial-Axis-Right-Eye.value[x]">
      <path value="Observation.component.value[x]" />
      <type>
        <code value="Quantity" />
      </type>
    </element>
    <element id="Observation.component:Pupil_Function_Confounders">
      <path value="Observation.component" />
      <sliceName value="Pupil_Function_Confounders" />
    </element>
    <element id="Observation.component:Pupil_Function_Confounders.value[x]">
      <path value="Observation.component.value[x]" />
      <type>
        <code value="CodeableConcept" />
      </type>
      <binding>
        <strength value="preferred" />
        <valueSet value="https://larfuma.github.io/fhir-eyecare-ig/ValueSet/Pupil-function-confounders" />
      </binding>
    </element>
  </differential>
</StructureDefinition>